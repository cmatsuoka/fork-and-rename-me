From bd91ae4286ea7ad5bf0f28eb3ef90361b3bfaa37 Mon Sep 17 00:00:00 2001
From: David Griffith <dave@661.org>
Date: Sat, 13 May 2017 17:29:44 -0700
Subject: [PATCH 64/68] Prevent segfault on some invalid gifs.

This is from
http://cvsweb.openbsd.org/cgi-bin/cvsweb/ports/graphics/xv/patches/patch-xvgif_c
---
 xvgif.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/xvgif.c b/xvgif.c
index 8542b7c..a854b3c 100644
--- a/xvgif.c
+++ b/xvgif.c
@@ -75,6 +75,7 @@ static boolean Interlace, HasGlobalColormap;
 static byte *RawGIF;		/* The heap array to hold it, raw */
 static byte *Raster;		/* The raster data stream, unblocked */
 static byte *pic8;
+static size_t rasterSize;
 
     /* The hash table used by the decompressor */
 static int Prefix[4096];
@@ -148,7 +149,8 @@ int LoadGIF(fname, pinfo)
   if (!(dataptr = RawGIF = (byte *) calloc((size_t) filesize+256, (size_t) 1)))
     FatalError("LoadGIF: not enough memory to read GIF file");
 
-  if (!(Raster = (byte *) calloc((size_t) filesize+256,(size_t) 1)))
+  rasterSize = filesize+256;
+  if (!(Raster = (byte *) calloc(rasterSize, (size_t) 1)))
     FatalError("LoadGIF: not enough memory to read GIF file");
 
   if (fread(dataptr, (size_t) filesize, (size_t) 1, fp) != 1)
@@ -796,6 +798,8 @@ static int readCode()
   int RawCode, ByteOffset;
 
   ByteOffset = BitOffset / 8;
+  if (ByteOffset >= rasterSize-2)
+    return 0;
   RawCode = Raster[ByteOffset] + (Raster[ByteOffset + 1] << 8);
   if (CodeSize >= 8)
     RawCode += ( ((int) Raster[ByteOffset + 2]) << 16);
-- 
2.17.1

